// Copyright 2016-2017 ELIFE. All rights reserved.
// Use of this source code is governed by a MIT
// license that can be found in the LICENSE file.
#include <inform/pid.h>
#include <ginger/unit.h>
#include <ginger/vector.h>

#define TestPIDSources(N,M) \
{ \
    pid_source **srcs = pid_sources((N)); \
    ASSERT_NOT_NULL(srcs); \
    ASSERT_EQUAL_U((M), gvector_cap(srcs)); \
    ASSERT_EQUAL_U((M), gvector_len(srcs)); \
    for (size_t i = 0; i < gvector_len(srcs); ++i) \
    { \
        ASSERT_NOT_NULL(srcs[i]); \
        ASSERT_NOT_NULL(srcs[i]->name); \
        ASSERT_EQUAL_U(gvector_len(srcs[i]->name), gvector_cap(srcs[i]->name)); \
 \
        ASSERT_NOT_NULL(srcs[i]->above); \
        ASSERT_EQUAL_U(0, gvector_len(srcs[i]->above)); \
 \
        ASSERT_NOT_NULL(srcs[i]->below); \
        ASSERT_EQUAL_U(0, gvector_len(srcs[i]->below)); \
    } \
 \
    for (size_t i = 0; i < gvector_len(srcs); ++i) \
    { \
        pid_source_free(srcs[i]); \
    } \
    gvector_free(srcs); \
}

#define COMPARE_SOURCES(EXP, SRCS) \
do { \
    for (size_t i = 0; i < gvector_len((SRCS)); ++i) \
    { \
        size_t const n = (EXP)[i][0]; \
        size_t const m = n * gvector_size((SRCS)[i]->name); \
        ASSERT_EQUAL_U(n, gvector_len((SRCS)[i]->name)); \
        ASSERT_EQUAL_U(0, memcmp(&((EXP)[i][1]), (SRCS)[i]->name, m)); \
    } \
} while(0);

#define TestPIDHasse(EXP, N, M) \
do { \
    pid_lattice *l = pid_hasse((N)); \
    ASSERT_NOT_NULL(l); \
    ASSERT_NOT_NULL(l->sources); \
    ASSERT_EQUAL_U((M), gvector_len(l->sources)); \
    COMPARE_SOURCES((EXP), l->sources); \
    pid_lattice_free(l); \
} while (0);


UNIT(PIDSources)
{
    TestPIDSources(1,1);
    TestPIDSources(2,4);
    TestPIDSources(3,18);
    TestPIDSources(4,166);
    TestPIDSources(5,7579);

    size_t expected[18][4] = {
        {1,1,0,0}, {2,1,6,0}, {2,1,4,0}, {2,1,2,0},
        {3,1,2,4}, {1,2,0,0}, {2,2,5,0}, {2,2,4,0},
        {1,3,0,0}, {2,3,6,0}, {2,3,5,0}, {3,3,5,6},
        {2,3,4,0}, {1,4,0,0}, {1,5,0,0}, {2,5,6,0},
        {1,6,0,0}, {1,7,0,0}
    };

    pid_source **srcs = pid_sources(3);
    ASSERT_NOT_NULL(srcs);
    ASSERT_EQUAL_U(18, gvector_len(srcs));

    COMPARE_SOURCES(expected, srcs);

    gvector_free(srcs);
}

UNIT(PIDToposort)
{
    size_t expected[166][7] = {
        {4,1,2,4,8,0,0},    {3,1,4,8,0,0,0},    {3,1,2,8,0,0,0},   {3,1,2,4,0,0,0},
        {3,2,4,8,0,0,0},    {3,1,6,8,0,0,0},    {3,1,4,10,0,0,0},  {3,1,2,12,0,0,0},
        {3,2,5,8,0,0,0},    {3,2,4,9,0,0,0},    {3,3,4,8,0,0,0},   {2,1,4,0,0,0,0},
        {2,1,2,0,0,0,0},    {2,2,8,0,0,0,0},    {4,2,5,9,12,0,0},  {2,2,4,0,0,0,0},
        {4,1,6,10,12,0,0},  {4,3,5,6,8,0,0},    {4,3,4,9,10,0,0},  {2,1,8,0,0,0,0},
        {2,4,8,0,0,0,0},    {3,2,9,12,0,0,0},   {3,2,5,12,0,0,0},  {3,2,5,9,0,0,0},
        {3,1,6,10,0,0,0},   {3,1,6,12,0,0,0},   {3,1,10,12,0,0,0}, {3,3,6,8,0,0,0},
        {3,3,5,8,0,0,0},    {6,3,5,6,9,10,12},  {3,3,4,10,0,0,0},  {3,3,4,9,0,0,0},
        {3,4,9,10,0,0,0},   {3,5,6,8,0,0,0},    {2,3,8,0,0,0,0},   {5,3,6,9,10,12,0},
        {2,2,12,0,0,0,0},   {5,3,5,9,10,12,0},  {2,1,6,0,0,0,0},   {5,3,5,6,10,12,0},
        {5,3,5,6,9,12,0},   {5,3,5,6,9,10,0},   {2,1,10,0,0,0,0},  {2,3,4,0,0,0,0},
        {2,2,5,0,0,0,0},    {2,1,12,0,0,0,0},   {2,4,10,0,0,0,0},  {2,4,9,0,0,0,0},
        {2,2,9,0,0,0,0},    {2,5,8,0,0,0,0},    {5,5,6,9,10,12,0}, {2,6,8,0,0,0,0},
        {4,3,6,10,12,0,0},  {4,3,6,9,12,0,0},   {4,3,6,9,10,0,0},  {4,3,5,10,12,0,0},
        {4,3,5,9,12,0,0},   {4,3,5,9,10,0,0},   {4,3,5,6,12,0,0},  {4,3,5,6,10,0,0},
        {4,3,5,6,9,0,0},    {2,1,14,0,0,0,0},   {4,3,9,10,12,0,0}, {2,4,11,0,0,0,0},
        {2,2,13,0,0,0,0},   {4,5,9,10,12,0,0},  {4,5,6,10,12,0,0}, {4,5,6,9,12,0,0},
        {4,5,6,9,10,0,0},   {4,6,9,10,12,0,0},  {2,7,8,0,0,0,0},   {3,3,5,12,0,0,0},
        {3,3,10,12,0,0,0},  {3,3,5,10,0,0,0},   {3,3,9,12,0,0,0},  {3,3,9,10,0,0,0},
        {3,3,6,9,0,0,0},    {1,1,0,0,0,0,0},    {1,2,0,0,0,0,0},   {1,4,0,0,0,0,0},
        {4,3,5,9,14,0,0},   {3,5,10,12,0,0,0},  {3,5,9,12,0,0,0},  {3,5,9,10,0,0,0},
        {3,3,6,12,0,0,0},   {4,5,6,11,12,0,0},  {3,5,6,10,0,0,0},  {3,5,6,9,0,0,0},
        {3,6,10,12,0,0,0},  {3,6,9,12,0,0,0},   {3,6,9,10,0,0,0},  {3,3,5,6,0,0,0},
        {4,3,6,10,13,0,0},  {4,7,9,10,12,0,0},  {1,8,0,0,0,0,0},   {2,5,10,0,0,0,0},
        {3,3,9,14,0,0,0},   {3,5,9,14,0,0,0},   {3,3,10,13,0,0,0}, {3,3,5,9,0,0,0},
        {3,5,6,12,0,0,0},   {3,5,6,11,0,0,0},   {3,3,6,13,0,0,0},  {2,3,12,0,0,0,0},
        {3,3,6,10,0,0,0},   {3,6,11,12,0,0,0},  {3,6,10,13,0,0,0}, {3,3,5,14,0,0,0},
        {2,6,9,0,0,0,0},    {3,7,10,12,0,0,0},  {3,7,9,12,0,0,0},  {3,7,9,10,0,0,0},
        {3,5,11,12,0,0,0},  {3,9,10,12,0,0,0},  {2,6,12,0,0,0,0},  {3,6,11,13,0,0,0},
        {2,6,10,0,0,0,0},   {2,3,6,0,0,0,0},    {3,3,13,14,0,0,0}, {2,5,12,0,0,0,0},
        {3,7,11,12,0,0,0},  {3,7,10,13,0,0,0},  {2,5,9,0,0,0,0},   {3,7,9,14,0,0,0},
        {2,5,6,0,0,0,0},    {2,3,10,0,0,0,0},   {3,5,11,14,0,0,0}, {2,3,5,0,0,0,0},
        {2,3,9,0,0,0,0},    {2,9,12,0,0,0,0},   {2,9,10,0,0,0,0},  {2,10,12,0,0,0,0},
        {2,7,12,0,0,0,0},   {4,7,11,13,14,0,0}, {2,7,10,0,0,0,0},  {2,3,14,0,0,0,0},
        {2,6,11,0,0,0,0},   {2,7,9,0,0,0,0},    {2,6,13,0,0,0,0},  {2,5,14,0,0,0,0},
        {2,3,13,0,0,0,0},   {2,5,11,0,0,0,0},   {2,9,14,0,0,0,0},  {2,10,13,0,0,0,0},
        {2,11,12,0,0,0,0},  {1,6,0,0,0,0,0},    {1,9,0,0,0,0,0},   {3,7,11,14,0,0,0},
        {1,3,0,0,0,0,0},    {1,10,0,0,0,0,0},   {1,5,0,0,0,0,0},   {3,7,13,14,0,0,0},
        {3,11,13,14,0,0,0}, {3,7,11,13,0,0,0},  {1,12,0,0,0,0,0},  {2,7,13,0,0,0,0},
        {2,11,14,0,0,0,0},  {2,11,13,0,0,0,0},  {2,7,11,0,0,0,0},  {2,7,14,0,0,0,0},
        {2,13,14,0,0,0,0},  {1,11,0,0,0,0,0},   {1,13,0,0,0,0,0},  {1,7,0,0,0,0,0},
        {1,14,0,0,0,0,0},   {1,15,0,0,0,0,0}
    };

    pid_source **srcs = pid_sources(4);
    ASSERT_NOT_NULL(srcs);
    ASSERT_EQUAL_U(166, gvector_len(srcs));

    pid_toposort(srcs);
    ASSERT_NOT_NULL(srcs);
    ASSERT_EQUAL_U(166, gvector_len(srcs));

    COMPARE_SOURCES(expected, srcs);

    gvector_free(srcs);
}

UNIT(PIDHasseOrder)
{
    {
        size_t expected[1][2] = { {1,1} };
        TestPIDHasse(expected, 1, 1);
    }

    {
        size_t expected[4][3] = { {2,1,2}, {1,1,0}, {1,2,0}, {1,3,0} };
        TestPIDHasse(expected, 2, 4);
    }

    {
        size_t expected[18][4] = {
            {3,1,2,4}, {2,1,4,0}, {2,1,2,0}, {2,2,4,0}, {2,2,5,0}, {2,1,6,0},
            {2,3,4,0}, {1,2,0,0}, {3,3,5,6}, {1,1,0,0}, {1,4,0,0}, {2,3,6,0},
            {2,3,5,0}, {2,5,6,0}, {1,5,0,0}, {1,3,0,0}, {1,6,0,0}, {1,7,0,0},
        };
        TestPIDHasse(expected, 3, 18);
    }

    {
        size_t expected[166][7] = {
            {4,1,2,4,8,0,0},    {3,1,4,8,0,0,0},    {3,1,2,8,0,0,0},   {3,1,2,4,0,0,0},
            {3,2,4,8,0,0,0},    {3,1,6,8,0,0,0},    {3,1,4,10,0,0,0},  {3,1,2,12,0,0,0},
            {3,2,5,8,0,0,0},    {3,2,4,9,0,0,0},    {3,3,4,8,0,0,0},   {2,1,4,0,0,0,0},
            {2,1,2,0,0,0,0},    {2,2,8,0,0,0,0},    {4,2,5,9,12,0,0},  {2,2,4,0,0,0,0},
            {4,1,6,10,12,0,0},  {4,3,5,6,8,0,0},    {4,3,4,9,10,0,0},  {2,1,8,0,0,0,0},
            {2,4,8,0,0,0,0},    {3,2,9,12,0,0,0},   {3,2,5,12,0,0,0},  {3,2,5,9,0,0,0},
            {3,1,6,10,0,0,0},   {3,1,6,12,0,0,0},   {3,1,10,12,0,0,0}, {3,3,6,8,0,0,0},
            {3,3,5,8,0,0,0},    {6,3,5,6,9,10,12},  {3,3,4,10,0,0,0},  {3,3,4,9,0,0,0},
            {3,4,9,10,0,0,0},   {3,5,6,8,0,0,0},    {2,3,8,0,0,0,0},   {5,3,6,9,10,12,0},
            {2,2,12,0,0,0,0},   {5,3,5,9,10,12,0},  {2,1,6,0,0,0,0},   {5,3,5,6,10,12,0},
            {5,3,5,6,9,12,0},   {5,3,5,6,9,10,0},   {2,1,10,0,0,0,0},  {2,3,4,0,0,0,0},
            {2,2,5,0,0,0,0},    {2,1,12,0,0,0,0},   {2,4,10,0,0,0,0},  {2,4,9,0,0,0,0},
            {2,2,9,0,0,0,0},    {2,5,8,0,0,0,0},    {5,5,6,9,10,12,0}, {2,6,8,0,0,0,0},
            {4,3,6,10,12,0,0},  {4,3,6,9,12,0,0},   {4,3,6,9,10,0,0},  {4,3,5,10,12,0,0},
            {4,3,5,9,12,0,0},   {4,3,5,9,10,0,0},   {4,3,5,6,12,0,0},  {4,3,5,6,10,0,0},
            {4,3,5,6,9,0,0},    {2,1,14,0,0,0,0},   {4,3,9,10,12,0,0}, {2,4,11,0,0,0,0},
            {2,2,13,0,0,0,0},   {4,5,9,10,12,0,0},  {4,5,6,10,12,0,0}, {4,5,6,9,12,0,0},
            {4,5,6,9,10,0,0},   {4,6,9,10,12,0,0},  {2,7,8,0,0,0,0},   {3,3,5,12,0,0,0},
            {3,3,10,12,0,0,0},  {3,3,5,10,0,0,0},   {3,3,9,12,0,0,0},  {3,3,9,10,0,0,0},
            {3,3,6,9,0,0,0},    {1,1,0,0,0,0,0},    {1,2,0,0,0,0,0},   {1,4,0,0,0,0,0},
            {4,3,5,9,14,0,0},   {3,5,10,12,0,0,0},  {3,5,9,12,0,0,0},  {3,5,9,10,0,0,0},
            {3,3,6,12,0,0,0},   {4,5,6,11,12,0,0},  {3,5,6,10,0,0,0},  {3,5,6,9,0,0,0},
            {3,6,10,12,0,0,0},  {3,6,9,12,0,0,0},   {3,6,9,10,0,0,0},  {3,3,5,6,0,0,0},
            {4,3,6,10,13,0,0},  {4,7,9,10,12,0,0},  {1,8,0,0,0,0,0},   {2,5,10,0,0,0,0},
            {3,3,9,14,0,0,0},   {3,5,9,14,0,0,0},   {3,3,10,13,0,0,0}, {3,3,5,9,0,0,0},
            {3,5,6,12,0,0,0},   {3,5,6,11,0,0,0},   {3,3,6,13,0,0,0},  {2,3,12,0,0,0,0},
            {3,3,6,10,0,0,0},   {3,6,11,12,0,0,0},  {3,6,10,13,0,0,0}, {3,3,5,14,0,0,0},
            {2,6,9,0,0,0,0},    {3,7,10,12,0,0,0},  {3,7,9,12,0,0,0},  {3,7,9,10,0,0,0},
            {3,5,11,12,0,0,0},  {3,9,10,12,0,0,0},  {2,6,12,0,0,0,0},  {3,6,11,13,0,0,0},
            {2,6,10,0,0,0,0},   {2,3,6,0,0,0,0},    {3,3,13,14,0,0,0}, {2,5,12,0,0,0,0},
            {3,7,11,12,0,0,0},  {3,7,10,13,0,0,0},  {2,5,9,0,0,0,0},   {3,7,9,14,0,0,0},
            {2,5,6,0,0,0,0},    {2,3,10,0,0,0,0},   {3,5,11,14,0,0,0}, {2,3,5,0,0,0,0},
            {2,3,9,0,0,0,0},    {2,9,12,0,0,0,0},   {2,9,10,0,0,0,0},  {2,10,12,0,0,0,0},
            {2,7,12,0,0,0,0},   {4,7,11,13,14,0,0}, {2,7,10,0,0,0,0},  {2,3,14,0,0,0,0},
            {2,6,11,0,0,0,0},   {2,7,9,0,0,0,0},    {2,6,13,0,0,0,0},  {2,5,14,0,0,0,0},
            {2,3,13,0,0,0,0},   {2,5,11,0,0,0,0},   {2,9,14,0,0,0,0},  {2,10,13,0,0,0,0},
            {2,11,12,0,0,0,0},  {1,6,0,0,0,0,0},    {1,9,0,0,0,0,0},   {3,7,11,14,0,0,0},
            {1,3,0,0,0,0,0},    {1,10,0,0,0,0,0},   {1,5,0,0,0,0,0},   {3,7,13,14,0,0,0},
            {3,11,13,14,0,0,0}, {3,7,11,13,0,0,0},  {1,12,0,0,0,0,0},  {2,7,13,0,0,0,0},
            {2,11,14,0,0,0,0},  {2,11,13,0,0,0,0},  {2,7,11,0,0,0,0},  {2,7,14,0,0,0,0},
            {2,13,14,0,0,0,0},  {1,11,0,0,0,0,0},   {1,13,0,0,0,0,0},  {1,7,0,0,0,0,0},
            {1,14,0,0,0,0,0},   {1,15,0,0,0,0,0}
        };

        TestPIDHasse(expected, 4, 166);
    }
}

BEGIN_SUITE(PID)
    ADD_UNIT(PIDSources)
    ADD_UNIT(PIDToposort)
    ADD_UNIT(PIDHasseOrder)
END_SUITE
